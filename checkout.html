<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Thanh toán — Tuấn Anh Điếu Cày</title>
<meta content="Trang thanh toán đơn hàng Tuấn Anh Điếu Cày" name="description"/>
<link href="img/logo.jpg" rel="icon"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&amp;display=swap" rel="stylesheet"/>
<link href="assets/style.css" rel="stylesheet"/>
<!-- PDF libs for client-side invoice -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</meta></head>
<body>
<header class="header">
<div class="container header__inner">
<a class="brand" href="index.html"><img alt="" class="brand__logo" src="img/logo.jpg"/> <span>Tuấn Anh Điếu Cày</span></a>
<nav class="nav"><a href="index.html#products">Sản phẩm</a><a href="flash-sale.html">Flash Sale</a></nav>
<div class="header__cta"><a class="btn btn--ghost" href="index.html">Quay lại</a></div>
</div>
</header>
<section class="checkout">
<div class="container">
<h1>Thanh toán</h1>
<div class="checkout__wrap">
<div class="box">
<h3>Thông tin đơn hàng</h3>
<div id="summary"></div>
<div class="total"><span>Tổng cộng:</span><strong id="sumTotal">0₫</strong></div>
</div>
<div class="box">
<h3>Thông tin khách hàng</h3>
<form action="https://formspree.io/f/meozvdoo" class="form-grid" id="payForm" method="POST">
<input name="_gotcha" style="display:none" type="text"/>
<input name="_subject" type="hidden" value="Đơn hàng mới - Tuấn Anh Điếu Cày (Checkout riêng)"/>
<input id="cartJson" name="cart_json" type="hidden" value="[]"/>
<input id="cartTotal" name="cart_total" type="hidden" value="0"/>
<div><label>Họ và tên</label><input name="name" required=""/></div>
<div><label>Số điện thoại</label><input name="phone" required=""/></div>
<div><label>Email</label><input name="email" required="" type="email"/></div>
<div>
<label>Phương thức thanh toán</label>
<select id="payment" name="payment_method" required="">
<option value="COD">COD</option>
<option value="BANK">Chuyển khoản</option>
<option value="MOMO">MoMo</option>
</select>
</div>
<div style="grid-column:1/-1"><label>Địa chỉ</label><input name="address" required=""/></div>
<div class="muted" id="guideCOD" style="grid-column:1/-1">Thanh toán khi nhận hàng (COD).</div>
<div class="muted" id="guideBANK" style="grid-column:1/-1;display:none">
<strong>Chuyển khoản SCB:</strong> STK <strong>329745.22222</strong> — Chủ TK <strong>Ngô Tuấn Anh</strong> — Nội dung: <em>Họ tên + SĐT</em>.
            </div>
<div class="muted" id="guideMOMO" style="grid-column:1/-1;display:none">
              MoMo: chuyển đến số <em>sẽ gửi khi xác nhận</em> với nội dung <em>Họ tên + SĐT</em>.
            </div>
<textarea name="note" placeholder="Ghi chú giao hàng / yêu cầu khác..." rows="3" style="grid-column:1/-1"></textarea>
<button class="btn" style="grid-column:1/-1" type="submit">Xác nhận và thanh toán</button>
<div class="alert success" id="ok" style="grid-column:1/-1">Đặt hàng thành công! Hóa đơn sẽ được tải xuống.</div>
<div class="alert error" id="err" style="grid-column:1/-1">Gửi thất bại. Vui lòng thử lại.</div>
</form>
</div>
</div>
</div>
</section>
<!-- Hidden invoice for rendering -->
<div id="invoice" style="width:800px;background:#fff;padding:24px;display:none">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
<div style="font-weight:800;font-size:20px">Tuấn Anh Điếu Cày</div>
<img alt="logo" src="img/logo.jpg" style="width:60px;height:60px;border-radius:8px;object-fit:cover"/>
</div>
<div id="invMeta" style="font-size:14px;color:#475569;margin-bottom:14px"></div>
<table style="width:100%;border-collapse:collapse">
<thead>
<tr>
<th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:8px 0">Sản phẩm</th>
<th style="text-align:right;border-bottom:1px solid #e5e7eb;padding:8px 0">SL</th>
<th style="text-align:right;border-bottom:1px solid #e5e7eb;padding:8px 0">Đơn giá</th>
<th style="text-align:right;border-bottom:1px solid #e5e7eb;padding:8px 0">Thành tiền</th>
</tr>
</thead>
<tbody id="invBody"></tbody>
<tfoot>
<tr>
<td colspan="3" style="text-align:right;padding-top:10px"><strong>Tổng cộng:</strong></td>
<td id="invTotal" style="text-align:right;padding-top:10px"><strong>0₫</strong></td>
</tr>
</tfoot>
</table>
<div style="margin-top:14px;font-size:12px;color:#64748b">
      Cảm ơn quý khách đã mua hàng! Liên hệ Zalo 0905.69.59.49 nếu cần hỗ trợ.
    </div>
</div>
<script>
    const money = n => (n||0).toLocaleString('vi-VN') + '₫';
    function syncGuides(v){
      document.getElementById('guideCOD').style.display = v==='COD'?'block':'none';
      document.getElementById('guideBANK').style.display = v==='BANK'?'block':'none';
      document.getElementById('guideMOMO').style.display = v==='MOMO'?'block':'none';
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      // Load cart
      const cart = JSON.parse(localStorage.getItem('cart')||'[]');
      const sumDiv = document.getElementById('summary');
      if (!cart.length){
        sumDiv.innerHTML = '<div class="muted">Giỏ hàng trống. <a href="index.html">Quay lại mua hàng</a>.</div>';
      } else {
        cart.forEach(it=>{
          const row = document.createElement('div');
          row.style.display='flex'; row.style.justifyContent='space-between';
          row.innerHTML = `<div>${it.name} <span class="muted">x${it.qty}</span></div><div><strong>${money(it.qty*it.price)}</strong></div>`;
          sumDiv.appendChild(row);
        });
      }
      const total = cart.reduce((s,i)=>s+i.qty*i.price,0);
      document.getElementById('sumTotal').textContent = money(total);

      // Push to hidden
      document.getElementById('cartJson').value = JSON.stringify(cart);
      document.getElementById('cartTotal').value = total;

      // Guides
      const payment = document.getElementById('payment');
      payment.addEventListener('change', ()=> syncGuides(payment.value));
      syncGuides(payment.value);

      // Submit
      document.getElementById('payForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const ok = document.getElementById('ok'), err = document.getElementById('err');
        ok.style.display='none'; err.style.display='none';
        const btn = e.target.querySelector('button[type="submit"]'); btn.disabled=true; btn.textContent='Đang gửi...';
        try{
          const data = new FormData(e.target);
          const res = await fetch(e.target.action, { method:'POST', body:data, headers:{Accept:'application/json'} });
          if (res.ok){
            ok.style.display='block';
            // Build invoice
            const invMeta = document.getElementById('invMeta');
            const name = e.target.querySelector('[name="name"]').value;
            const phone = e.target.querySelector('[name="phone"]').value;
            const pm = e.target.querySelector('[name="payment_method"]').value;
            const now = new Date();
            invMeta.innerHTML = `Khách hàng: <strong>${name}</strong> — ${phone}<br>Mã hóa đơn: HD${now.getFullYear()}${(now.getMonth()+1+'').padStart(2,'0')}${(now.getDate()+'').padStart(2,'0')}-${now.getTime().toString().slice(-5)} — PT thanh toán: <strong>${pm}</strong><br>Ngày: ${now.toLocaleString('vi-VN')}`;
            const invBody = document.getElementById('invBody'); invBody.innerHTML='';
            cart.forEach(it=>{
              const tr = document.createElement('tr');
              tr.innerHTML = `<td style="padding:6px 0;border-bottom:1px solid #e5e7eb">${it.name}</td>
                              <td style="padding:6px 0;text-align:right;border-bottom:1px solid #e5e7eb">${it.qty}</td>
                              <td style="padding:6px 0;text-align:right;border-bottom:1px solid #e5e7eb">${money(it.price)}</td>
                              <td style="padding:6px 0;text-align:right;border-bottom:1px solid #e5e7eb">${money(it.qty*it.price)}</td>`;
              invBody.appendChild(tr);
            });
            document.getElementById('invTotal').innerHTML = '<strong>'+money(total)+'</strong>';

            // Render to PDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p','pt','a4');
            const inv = document.getElementById('invoice');
            inv.style.display='block';
            const canvas = await html2canvas(inv, {scale:2});
            const img = canvas.toDataURL('image/png');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const ratio = Math.min(pageWidth / canvas.width, pageHeight / canvas.height);
            const imgW = canvas.width * ratio;
            const imgH = canvas.height * ratio;
            const x = (pageWidth - imgW)/2;
            const y = 20;
            pdf.addImage(img, 'PNG', x, y, imgW, imgH);
            pdf.save('hoa-don.pdf');
            inv.style.display='none';

            // Clear cart and redirect
            localStorage.removeItem('cart');
          } else {
            err.style.display='block';
          }
        }catch(ex){
          console.error(ex);
          err.style.display='block';
        } finally {
          btn.disabled=false; btn.textContent='Xác nhận và thanh toán';
        }
      });
    });
  </script>
</body>
</html>