
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin — Quản lý sản phẩm</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .admin { max-width: 960px; margin: 40px auto; padding: 16px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .table { width: 100%; border-collapse: collapse; margin-top: 24px; }
    .table th,.table td{ border:1px solid #eee; padding:8px; text-align:left; }
    .row-actions button{ margin-right:8px; }
    .muted{color:#666;font-size:14px}
    input[type="checkbox"]{ transform: scale(1.2); }
  </style>
</head>
<body>
  <div class="admin">
    <h1>Quản lý sản phẩm</h1>
    <p class="muted">Đăng nhập email/password để quản trị. Ảnh nên lưu trên Firebase Storage rồi dán URL.</p>

    <div id="authBox">
      <input id="email" type="email" placeholder="Email quản trị">
      <input id="password" type="password" placeholder="Mật khẩu">
      <button id="btnLogin">Đăng nhập</button>
      <button id="btnLogout" style="display:none">Đăng xuất</button>
      <span id="whoami" class="muted"></span>
    </div>

    <h2>Thêm / Sửa sản phẩm</h2>
    <div class="grid">
      <label>Tên sản phẩm
        <input id="name" type="text" placeholder="VD: Điếu cày...">
      </label>
      <label>Giá hiện tại (VND)
        <input id="price" type="number" min="0" step="1000">
      </label>
      <label>Giá gạch (tuỳ chọn)
        <input id="original_price" type="number" min="0" step="1000">
      </label>
      <label>Ảnh (URL)
        <input id="image" type="url" placeholder="https://...">
      </label>
      <label style="display:flex;gap:8px;align-items:center">
        <input id="is_sale" type="checkbox"> Flash Sale
      </label>
      <input id="docId" type="hidden">
      <div>
        <button id="btnSave">Lưu</button>
        <button id="btnReset" class="muted">Reset form</button>
      </div>
    </div>

    <h2>Danh sách</h2>
    <table class="table">
      <thead><tr>
        <th>Tên</th><th>Giá</th><th>Giá gạch</th><th>Flash</th><th>Ảnh</th><th>Hành động</th>
      </tr></thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

<script type="module">
import { app, db, auth } from "./assets/firebase-config.js";
import {
  collection, addDoc, serverTimestamp, onSnapshot, orderBy, query,
  updateDoc, doc, deleteDoc, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import {
  signInWithEmailAndPassword, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

const $ = s => document.querySelector(s);
const rows = $("#rows");

$("#btnLogin").onclick = async () => {
  try {
    const user = await signInWithEmailAndPassword(auth, $("#email").value, $("#password").value);
  } catch(e){ alert(e.message); }
};
$("#btnLogout").onclick = () => signOut(auth);

onAuthStateChanged(auth, (user)=>{
  $("#whoami").textContent = user ? `Đã đăng nhập: ${user.email}` : "Chưa đăng nhập";
  $("#btnLogin").style.display = user ? "none" : "inline-block";
  $("#btnLogout").style.display = user ? "inline-block" : "none";
});

function toNum(v){ const n = Number(v); return Number.isFinite(n) ? n : null; }

$("#btnSave").onclick = async () => {
  const payload = {
    name: $("#name").value.trim(),
    price: toNum($("#price").value),
    original_price: toNum($("#original_price").value),
    image: $("#image").value.trim(),
    is_sale: $("#is_sale").checked,
    updatedAt: serverTimestamp(),
  };
  if (!payload.name) { alert("Nhập tên sản phẩm"); return; }

  const id = $("#docId").value;
  try {
    if (id) {
      await updateDoc(doc(db, "products", id), payload);
    } else {
      payload.createdAt = serverTimestamp();
      await addDoc(collection(db, "products"), payload);
    }
    resetForm();
  } catch(e){ alert(e.message); }
};

$("#btnReset").onclick = resetForm;
function resetForm(){
  $("#docId").value = "";
  $("#name").value = "";
  $("#price").value = "";
  $("#original_price").value = "";
  $("#image").value = "";
  $("#is_sale").checked = false;
}

function editRow(id){
  return async () => {
    const snap = await getDoc(doc(db, "products", id));
    const p = snap.data();
    $("#docId").value = id;
    $("#name").value = p.name || "";
    $("#price").value = p.price || "";
    $("#original_price").value = p.original_price || "";
    $("#image").value = p.image || "";
    $("#is_sale").checked = !!p.is_sale;
    window.scrollTo({top:0,behavior:'smooth'});
  };
}

function deleteRow(id){
  return async () => {
    if (!confirm("Xoá sản phẩm này?")) return;
    await deleteDoc(doc(db, "products", id));
  };
}

onSnapshot(query(collection(db, "products"), orderBy("createdAt", "desc")), (snap)=>{
  rows.innerHTML = "";
  snap.forEach(docu => {
    const p = {id: docu.id, ...docu.data()};
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.name||""}</td>
      <td>${p.price??""}</td>
      <td>${p.original_price??""}</td>
      <td>${p.is_sale ? "✔" : ""}</td>
      <td>${p.image ? `<a href="${p.image}" target="_blank">Xem</a>` : ""}</td>
      <td class="row-actions">
        <button data-ed="${p.id}">Sửa</button>
        <button data-del="${p.id}">Xoá</button>
      </td>
    `;
    rows.appendChild(tr);
  });
  rows.querySelectorAll("button[data-ed]").forEach(b=> b.onclick = editRow(b.dataset.ed));
  rows.querySelectorAll("button[data-del]").forEach(b=> b.onclick = deleteRow(b.dataset.del));
});
</script>
</body>
</html>
